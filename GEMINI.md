# GEMINI.md — 避けるだけ.com（TypeScript × Phaser × Vite）

> **目的**: このリポジトリに対して Gemini CLI が安全・一貫・高品質に変更提案やコード生成を行えるよう、プロジェクト文脈・方針・出力形式・制約を明文化する。  
> **対象読者**: Gemini CLI（および人間の開発者）。  
> **言語**: すべての解説・コメント・やり取りは **日本語**。コードや識別子は英語を基本とする。

---

## 0. ロール定義（Gemini への指示）

あなたは本プロジェクト「**避けるだけ.com**」の**ペアプロ兼レビュアー**です。  
**最小差分（小さく安全な変更）**・**再現可能性**・**読みやすさ**・**パフォーマンス**を最優先に、以下を厳守して作業してください。

- **必須原則**
  - 不明点は**推測せず**、根拠を示しながら**質問を列挙**する（ただし要求物の作成は可能な範囲で先に出す）
  - 事実参照が必要な場合は**公式ドキュメントを優先**し、根拠（出典）を短く明記する
  - **既存アーキテクチャを尊重**し、不要な依存の追加・大規模リファクタは提案レベルに留める
  - 生成物は**ビルドが通る**こと／**型エラーがない**こと
  - 変更は**説明可能性**（理由と代替案）を伴うこと

- **出力の既定フォーマット**
  1) **Plan**（やることの要約・影響範囲）  
  2) **Diff**（`git unified diff`、最小&自己完結。新規ファイルはフル内容）  
  3) **Rationale**（なぜその設計／値にしたか。代替案）  
  4) **Test Plan**（手動確認手順 + 任意の自動テスト）  
  5) **Follow-ups**（後でやる改善）

- **禁止事項**
  - ライセンス不明ソースのコピー&ペースト
  - 大きな設計変更・依存追加（**明示許可**がある場合のみ）
  - 過度なグローバル状態・`update` ループ内の高コスト処理・GC促進コード
  - 致命的マジックナンバーの散在（**定数化**／根拠コメントを伴うこと）

---

## 1. プロジェクト概要

- **ジャンル**: 2D 避けゲーム（上から落下／横から飛来する障害物を左右移動で回避）
- **難易度目標**: 平均 **45秒** 生存（プレイヤー初期残基 1、まれに +1 ライフ）
- **終了条件**: 残基 0 で**ゲームオーバー**、**生存時間**と**ベスト**を表示（ローカル保存）
- **ビルド/配信**: **Vite** でビルドし **GitHub Pages** に Actions で自動デプロイ
- **デザイン**: ダーク＋ネオン（スタイリッシュ）。外部アセット無し（**生成テクスチャ**）

---

## 2. 技術スタックと主要設計

- **言語**: TypeScript（`strict: true`）
- **ゲームエンジン**: Phaser 3（Arcade Physics）
- **ビルド**: Vite（ESM／`vite preview` で検証）
- **配信**: GitHub Pages（`vite.config.ts` の `base` は CI 環境変数で自動設定）
- **入出力**: キー（←→ / A D）、タッチ（画面左右）。スコアは `localStorage` のみ。
- **シーン構成**: `PreloadScene`（生成テクスチャ）→ `GameScene`（本編）
- **主なゲーム要素**
  - **障害物**: `drop`（縦落下） / `diag`（斜め飛来） / `sine`（左右揺れ落下）
  - **アイテム**: 低確率（約 0.5%）で出現するライフ (+1、最大3)
  - **難易度曲線**: 経過秒に応じて**落下速度上昇**・**出現間隔短縮**・**パターン比率変更**

---

## 3. リポジトリ構成（基準）

```
/src
  /scenes
    PreloadScene.ts   # 生成テクスチャ（背景グリッド／プレイヤー／敵／アイテム）
    GameScene.ts      # ゲーム本体（挙動・難易度・HUD・入出力・リザルト）
  main.ts             # Phaser.Game 構成（480x800, Scale.FIT）
  style.css           # ダーク＋ネオンUI
index.html            # タイトル：避けるだけ.com（Orbitron フォント）
vite.config.ts        # GitHub Pages 配信用の base 自動設定
```

> **編集ポリシー**: シーン分割はシンプルさ優先。ロジックの純化が必要な場合は `/src/game/` に**純関数**として抽出し、テスト可能にする。

---

## 4. 難易度・バランス調整規約

- **目標**: 初見～数回プレイの平均で **45 ± 10 秒** でゲームオーバー
- **主要パラメータ（例）**
  - `BASE_SPEED`（初速, px/s）
  - `SPEED_PER_SEC`（毎秒加速, px/s^2 の擬似）
  - `BASE_SPAWN_MS`（初期スポーン間隔, ms）
  - `MIN_SPAWN_MS`（最小スポーン間隔, ms）
  - `SPAWN_EASE`（秒あたり短縮量, ms/s）
  - `RARE_ITEM_PROB`（アイテム出現確率, 0-1）
- **調整手順（推奨）**
  1. **計測**: 10回分の生存時間を収集（手動でも可）。平均・中央値を算出。
  2. **仮説**: 速度不足か密度不足かを切り分け（被弾原因ログ／画面観察）。
  3. **微調整**: 片側のみ 5–10% 変更→再計測。**同時多変数変更は禁止**。
  4. **根拠の記録**: 変更理由・数値根拠を該当定数の上にコメントで残す。

> **注意**: 体感難易度は**速度＞密度**の影響が大きい。先に `SPEED_PER_SEC` を触り、飽和してから `SPAWN_EASE` / `MIN_SPAWN_MS` を調整する。

---

## 5. パフォーマンスと可読性の原則

- `update` ループでは**メモリ割当/解放を最小化**（`new`・クロージャ生成を避ける）
- 画面外のスプライトは**即破棄**・Group 管理を徹底
- 当たり判定は**円形/矩形**の簡易で十分（Arcade Physics の軽量性を活かす）
- マジックナンバーは**定数化**・**根拠コメント**を付ける
- 高頻度ログ出力は避ける（Dev 時のみガード）

---

## 6. ビルド・実行・デプロイ

- **ローカル**: `npm run dev` / `npm run build` / `npm run preview`
- **CI/CD**: GitHub Actions で `dist/` を Pages へ公開（`deploy-pages`）。
- **Vite base**: CI の `GITHUB_REPOSITORY` に基づき自動設定。**手動で書き換えない**。

---

## 7. テスト方針（最小でも実装）

> Phaser 依存の統合テストは重いため、**ロジックを純関数に抽出**し **Vitest** で検証。

- **対象**:  
  - スポーン**間隔計算**、**速度曲線**、**出現パターン比率**（`pickKind`）  
  - ライフ増減、**無敵時間**の境界条件
- **手法**:  
  - `src/game/balance.ts` などに抽出し、**純関数**としてテスト  
  - 時刻・乱数は**スタブ**（`vi.setSystemTime`, `vi.spyOn(Math, 'random')`）
- **非対象（目視確認）**: パーティクル演出、HUD レイアウト
- **最小セットアップ（提案）**:  
  - `devDependencies`: `vitest`, `@vitest/coverage-v8`, `happy-dom`（必要時）  
  - `npm scripts`: `"test": "vitest run", "coverage": "vitest run --coverage"`

---

## 8. コーディング規約

- **命名**: 英語、意味を圧縮し過ぎない。ブーリアンは `is/has/can` 接頭。
- **型**: `strict: true` を前提。`any` 禁止（やむを得ない場合は TODO と根拠）。
- **レイアウト**: Prettier 互換 2スペース・行末セミコロンあり（既存に合わせる）。
- **コメント**: 値の**根拠**・**意図**を最優先。コードの言い換えは不要。
- **資産**: 画像は**生成テクスチャ**優先。外部アセットを増やさない。

---

## 9. 変更提案・PR・コミット規約

- **コミット**: Conventional Commits（例: `feat: add sine obstacle wobble control`）。
- **PR 説明**（テンプレ）:
  - 目的 / 変更点 / スクリーンショット or 動画 / リスク&リカバリ / テスト計画
- **大きな変更**は**設計メモ**（Decision record）を `docs/adr/` に残す。

---

## 10. Gemini への依頼テンプレ

> すべての変更依頼は以下の型で行う。出力も「Plan → Diff → Rationale → Test Plan → Follow-ups」の順。

- **機能追加**（例：障害物の新パターン）  
  「`sine` に振幅制御を追加したい。`GameScene.spawnObstacle('sine')` を拡張して、難易度に応じて `amp` と `freq` の上限を引き上げる。既存難易度の平均45秒を崩さないこと。**最小差分**で、定数の根拠コメントも追加。出力は Plan→Diff→…」

- **難易度調整**  
  「平均が 60 秒に伸びた。`SPEED_PER_SEC` を 5–10% の範囲で調整し再計測できるよう `src/game/balance.ts` を導入。テスト追加（`pickKind` が時間 t の増加で `sine` 比率が単調増加すること）。Plan→Diff→…」

- **不具合修正**  
  「無敵時間中に当たり判定が再発火する。`invincibleUntil` ガードの欠陥を修正。回帰を防ぐユニットテストを追加。Plan→Diff→…」

- **ドキュメント**  
  「README に操作方法・デプロイの手順を追加。スクショ 1 枚を `docs/` へ。Plan→Diff→…」

---

## 11. セキュリティ・プライバシー

- 外部ネットワーク通信はしない（解析・トラッキング無し）
- スコアは `localStorage` のみ（個人情報は扱わない）

---

## 12. 将来の拡張（任意）

- 効果音/BGM（アセット方針とライセンス明記）
- モバイル UI（透過ボタン／バイブレーション）
- オンラインランキング（サーバレス基盤／チート対策方針）

---

## 13. このファイルの更新手順

- 重大な方針変更やパラメータ更新時は、本ファイルも**同一PR**で更新
- 冒頭「ロール定義」に**新ルールを追記**し、差分を明確化

---

## 付録 A: 既知の定数（目安値）

> **注**: これらは目安。実測に基づき調整。

```ts
// 難易度カーブ（平均45秒狙い）
BASE_SPEED    = 180;
SPEED_PER_SEC = 4.5;
BASE_SPAWN_MS = 900;
MIN_SPAWN_MS  = 260;
SPAWN_EASE    = 11;
RARE_ITEM_PROB= 0.005; // 0.5% 程度
```

---

## 付録 B: 参考（Gemini への観点）

- **Phaser Arcade Physics** は軽量な当たり判定と速度制御を提供。矩形/円形が簡便。
- **Vite + GitHub Pages** では `base` 設定が必須（CI/Pages 公開パスと一致させる）。
- **GEMINI.md** はプロジェクト指向の**永続コンテキスト**として読み込まれる。

> 参照（人間向け）: 公式/一次情報を優先して検索して確認すること。

